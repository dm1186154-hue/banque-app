import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const soldeEl = document.getElementById("solde");
const logoutBtn = document.getElementById("logout");
const transfertBtn = document.getElementById("btn-transfert");
const historiqueBtn = document.getElementById("btn-historique");
const msg = document.getElementById("message");
const userName = document.getElementById("display-name");

// Modal transfert
const modal = document.getElementById("modal-transfert");
const confirmerBtn = document.getElementById("confirmer-transfert");
const annulerBtn = document.getElementById("annuler-transfert");
const montantInput = document.getElementById("montant");
const destinataireInput = document.getElementById("destinataire");
const modalMsg = document.getElementById("modal-message");

let currentUser;
let currentSolde = 0;

// Chargement de lâ€™utilisateur
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "connexion.html";
  } else {
    currentUser = user;
    const docRef = doc(db, "comptes", user.uid);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      const data = docSnap.data();
      currentSolde = data.solde || 0;
      soldeEl.textContent = `${currentSolde.toLocaleString()} FCFA`;
      userName.textContent = `${data.prenom || "Utilisateur"} ${data.nom || ""}`;
    }
  }
});

// DÃ©connexion
logoutBtn.addEventListener("click", () => {
  signOut(auth).then(() => (window.location.href = "connexion.html"));
});

// Ouvrir le modal
transfertBtn.addEventListener("click", () => {
  modal.style.display = "flex";
});

// Fermer le modal
annulerBtn.addEventListener("click", () => {
  modal.style.display = "none";
  modalMsg.textContent = "";
  montantInput.value = "";
  destinataireInput.value = "";
});

// Confirmer transfert
confirmerBtn.addEventListener("click", async () => {
  const montant = parseFloat(montantInput.value);
  const destinataire = destinataireInput.value.trim();

  if (!montant || montant <= 0 || !destinataire) {
    modalMsg.textContent = "âš ï¸ Saisis un montant valide et un numÃ©ro de destinataire.";
    return;
  }

  if (montant > currentSolde) {
    modalMsg.textContent = "âŒ Solde insuffisant.";
    return;
  }

  const newSolde = currentSolde - montant;
  const docRef = doc(db, "comptes", currentUser.uid);

  await updateDoc(docRef, { solde: newSolde });

  currentSolde = newSolde;
  soldeEl.textContent = `${newSolde.toLocaleString()} FCFA`;
  modalMsg.textContent = "âœ… Transfert effectuÃ© avec succÃ¨s !";
  setTimeout(() => {
    modal.style.display = "none";
  }, 2000);
});

// Historique (provisoire)
historiqueBtn.addEventListener("click", () => {
  msg.textContent = "ğŸ“œ Lâ€™historique des transactions sera bientÃ´t disponible...";
});
