// =============================
//  IMPORTS FIREBASE
// =============================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
    getAuth, 
    RecaptchaVerifier, 
    signInWithPhoneNumber,
    signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// =============================
//  CONFIG FIREBASE (Ton code)
// =============================
const firebaseConfig = {
    apiKey: "AIzaSyAwGbQuv9EoIvBm7WC0OLTQ41cgleXd804",
    authDomain: "banque-app-66bf9.firebaseapp.com",
    projectId: "banque-app-66bf9",
    storageBucket: "banque-app-66bf9.firebasestorage.app",
    messagingSenderId: "833823730245",
    appId: "1:833823730245:web:64dd77db2f273d24f9912c"
};

// =============================
//  INITIALISATION
// =============================
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Utiliser automatiquement la langue du tÃ©lÃ©phone
auth.useDeviceLanguage();

// =============================
//  RECAPTCHA INVISIBLE FIREBASE
// =============================
window.recaptchaVerifier = new RecaptchaVerifier(
    auth, 
    "recaptcha-container",
    {
        size: "invisible",
        callback: (response) => {
            console.log("reCAPTCHA validÃ© ðŸ‘");
        }
    }
);

// =============================
//  INSCRIPTION / CONNEXION (mÃªme systÃ¨me)
// =============================
let confirmationResult;

// ðŸ“Œ Bouton : envoyer le code OTP
document.getElementById("sendCode").addEventListener("click", () => {
    const phoneNumber = document.getElementById("phone").value;

    if (!phoneNumber) {
        alert("Veuillez entrer un numÃ©ro de tÃ©lÃ©phone !");
        return;
    }

    const appVerifier = window.recaptchaVerifier;

    signInWithPhoneNumber(auth, phoneNumber, appVerifier)
        .then((result) => {
            confirmationResult = result;
            alert("Un code a Ã©tÃ© envoyÃ© Ã  votre numÃ©ro âœ”ï¸");
            console.log("Code envoyÃ© !");
        })
        .catch((error) => {
            console.error(error);
            alert(error.message);
        });
});

// ðŸ“Œ VÃ©rifier le code OTP
document.getElementById("verifyCode").addEventListener("click", () => {
    const code = document.getElementById("otp").value;

    if (!code) {
        alert("Veuillez entrer le code reÃ§u !");
        return;
    }

    confirmationResult
        .confirm(code)
        .then((result) => {
            const user = result.user;
            alert("Connexion rÃ©ussie âœ”ï¸");
            window.location.href = "dashboard.html"; // Redirige vers le tableau de bord
        })
        .catch((error) => {
            console.error(error);
            alert("Code incorrect âŒ");
        });
});

// =============================
//  DÃ‰CONNEXION
// =============================
document.getElementById("logout")?.addEventListener("click", () => {
    signOut(auth)
        .then(() => {
            alert("DÃ©connexion rÃ©ussie âœ”ï¸");
            window.location.href = "index.html";
        })
        .catch((error) => {
            console.error(error);
        });
});
